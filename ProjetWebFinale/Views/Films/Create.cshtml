@model ProjetWebFinale.Models.Films

@{
    ViewData["Title"] = "Create";
}


<h1>Ajouter un nouveau DVD</h1>

<h4>Films</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Create" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group" style="display:none;">
                <label asp-for="DateMAJ" class="control-label"></label>
                <input asp-for="DateMAJ" class="form-control" />
                <span asp-validation-for="DateMAJ" class="text-danger"></span>
            </div>
            <div class="form-group" style="display:none;">
                <label asp-for="NoUtilisateurMAJ" class="control-label"></label>
                <select asp-for="NoUtilisateurMAJ" class="form-control" asp-items="ViewBag.NoUtilisateurMAJ" hidden></select>
            </div>

            <div class="form-group">
                <label asp-for="AnneeSortie" class="control-label">Année de sortie du film:</label>
                <input asp-for="AnneeSortie" class="form-control" class="form-control" type="number" min="1900" max="" data-val="true" />
                <span asp-validation-for="AnneeSortie" class="text-danger"></span>
                <script>
                    var currentYear = new Date().getFullYear();
                    document.getElementById("AnneeSortie").max = currentYear;

                </script>

            </div>
            <br>

            <div class="form-group">
                <label asp-for="Categorie" class="control-label">Catégorie:</label>
                <select asp-for="Categorie" class="form-control" asp-items="ViewBag.Categorie">
                    <option value=""></option>
                </select>
            </div>
            <br>

            <div class="form-group">
                <label asp-for="Format" class="control-label">Format:</label>
                <select asp-for="Format" class="form-control" asp-items="ViewBag.Format">
                    <option value=""></option>
                </select>
            </div>
            <br>
            <div class="form-group">
                <label asp-for="Resume" class="control-label">Résumé du film:</label>
                <textarea asp-for="Resume" class="form-control"></textarea>
                <span asp-validation-for="Resume" class="text-danger"></span>
            </div>
            <br>

            <div class="form-group">
                <label asp-for="DureeMinutes" class="control-label">Durée du film (minutes): </label>
                <input asp-for="DureeMinutes" class="form-control" type="number" min="1" data-val="true" />
                <span asp-validation-for="DureeMinutes" class="text-danger"></span>
            </div>
            <br>

            <div class="form-group">
                <label asp-for="FilmOriginal" class="control-label">Film original?</label>
                <select asp-for="FilmOriginal" class="form-control">
                    <option value=""></option>
                    <option value="true">True</option>
                    <option value="false">False</option>
                </select>
                <span asp-validation-for="FilmOriginal" class="text-danger"></span>
            </div>
            <br>

            <div class="form-group">
                <label asp-for="ImagePochette" class="control-label">Image de l'affiche du film :</label>
                <input type="file" id="file" name="file" accept="image/jpeg" class="form-control" />
                <span asp-validation-for="ImagePochette" class="text-danger"></span>
            </div>
            <br>

            <div class="form-group">
                <label asp-for="NbDisques" class="control-label">Nombre de disques:</label>
                <input asp-for="NbDisques" class="form-control" class="form-control" type="number" min="1" data-val="true" />
                <span asp-validation-for="NbDisques" class="text-danger"></span>
            </div>
            <br>

            <div class="form-group">
                <label asp-for="TitreFrancais" class="control-label">Titre en Français:</label>
                <input asp-for="TitreFrancais" class="form-control" />
                <span asp-validation-for="TitreFrancais" class="text-danger"></span>
            </div>
            <br>

            <div class="form-group">
                <label asp-for="TitreOriginal" class="control-label">Titre original:</label>
                <input asp-for="TitreOriginal" class="form-control" />
                <span asp-validation-for="TitreOriginal" class="text-danger"></span>
            </div>
            <br>

            <div class="form-group">
                <label asp-for="VersionEtendue" class="control-label">Version étendue?</label>
                <select asp-for="VersionEtendue" class="form-control">
                    <option value=""></option>
                    <option value="true">True</option>
                    <option value="false">False</option>
                </select>
                <span asp-validation-for="VersionEtendue" class="text-danger"></span>
            </div>
            <br>

            <div class="form-group">
                <label asp-for="NoRealisateur" class="control-label">Nom du réalisateur:</label>
                <select asp-for="NoRealisateur" class="form-control" asp-items="ViewBag.NoRealisateur">
                    <option value=""></option>
                </select>
            </div>
            <br>

            <div class="form-group">
                <label asp-for="NoProducteur" class="control-label">Nom du producteur:</label>
                <select asp-for="NoProducteur" class="form-control" asp-items="ViewBag.NoProducteur">
                    <option value=""></option>
                </select>
            </div>
            <br>

            <div class="form-group">
                <label asp-for="NoUtilisateurProprietaire" class="control-label">Nom du propriétaire du film:</label>
                <select asp-for="NoUtilisateurProprietaire" class="form-control" asp-items="ViewBag.NoUtilisateurProprietaire"></select>
            </div>
            <br>

            <div class="form-group">
                <label asp-for="Xtra" class="control-label">Informations supplémentaires:</label>
                <input asp-for="Xtra" class="form-control" />
                <span asp-validation-for="Xtra" class="text-danger"></span>
            </div>
            <br>

            <div class="form-group">
                <label class="control-label">Langue : </label>
                @if (ViewBag.Langues != null)
                {
                    foreach (var language in ViewBag.Langues)
                    {
                        <input type="checkbox" name="selectedLangues" value="@language.Value" class="form-check-input" />
                        <label class="form-check-label">@language.Text</label>
                    }
                }
                else
                {
                    <p>Aucune langues disponibles</p>
                }
            </div>
            <br>

            <div class="form-group">
                <label class="control-label">Sous-titres : </label>
                @if (ViewBag.SousTitres != null)
                {
                    foreach (var sousTitre in ViewBag.SousTitres)
                    {
                        <input type="checkbox" name="selectedSousTitres" value="@sousTitre.Value" class="form-check-input" />
                        <label class="form-check-label">@sousTitre.Text</label>
                    }
                }
                else
                {
                    <p>Aucun sous-titres disponibles</p>
                }
            </div>
            <br>

            <div class="form-group">
                <label class="control-label">Suppléments : </label>
                @if (ViewBag.Supplements != null)
                {
                    foreach (var supplements in ViewBag.Supplements)
                    {
                        <div class="form-check">
                            <input type="checkbox" name="selectedSupplements" value="@supplements.Value" class="form-check-input" />
                            <label class="form-check-label">@supplements.Text</label>
                        </div>
                    }
                }
                else
                {
                    <p>Aucune suppléments disponibles</p>
                }
            </div>
            <br>

            @{
                var maxActeurs = 3;
            }

            <script>

                function validateActeursSelection() {
                    var checkboxes = document.querySelectorAll('input[name="selectedActeurs"]:checked');
                    var checkedValues = Array.from(checkboxes).map(function (checkbox) {
                        return checkbox.value;
                    });
                    var errorMessage = document.getElementById('acteursValidationError');
                    if (checkedValues.length > @maxActeurs) {
                        errorMessage.textContent = 'Un maximum de @maxActeurs acteurs peut être sélectionné.';
                        return false;
                    } else {
                        errorMessage.textContent = '';
                        return true;
                    }
                }

                function addNewActeur() {
                    var newActeurInput = document.getElementById('newActeur');
                    var newActeurGenderInput = document.getElementById('newActeurGender');
                    var newActeur = newActeurInput.value.trim();
                    var newActeurGender = newActeurGenderInput.value;

                    // Validate inputs
                    if (!newActeur || !newActeurGender) {
                        alert('Veuillez fournir un nom et sélectionnez un genre.');
                        return;
                    }

                    // Call the controller action using AJAX
                    $.ajax({
                        url: '/Films/AddActor',
                        type: 'POST',
                        data: { nom: newActeur, sexe: newActeurGender },
                        success: function (result) {
                            if (result.success) {
                                // Handle success, update UI, etc.
                                alert(result.message);

                                // Access the actor ID from the response
                                var newActorId = result.actorId;

                                // Add the new actor as a checkbox with the correct value (ID)
                                var newActeurCheckbox = document.createElement('div');
                                newActeurCheckbox.className = 'col-md-3';
                                newActeurCheckbox.innerHTML = `
                                                <div class="form-check">
                                                    <input type="checkbox" name="selectedActeurs" value="${newActorId}" class="form-check-input"
                                                     onclick="validateActeursSelection(); return validateActeursSelection();" />
                                                    <label class="form-check-label">${newActeur}</label>
                                                </div>
                                            `;
                                document.getElementById('acteursContainer').appendChild(newActeurCheckbox);

                                // Manually trigger the toggle function to handle the selection
                                toggleActeurSelection(newActorId);

                                // Clear the input
                                newActeurInput.value = '';
                                newActeurGenderInput.value = '';

                                // Validate the selection
                                validateActeursSelection();
                            } else {
                                // Handle validation error or other errors
                                alert(result.message);
                            }
                        },
                        error: function () {
                            // Handle AJAX error
                            alert('An error occurred while adding the actor.');
                        }
                    });
                }
            </script>

            <div class="form-group">
                <label class="control-label">Acteurs : </label>
                <div id="acteursContainer" class="row">
                    @if (ViewBag.Acteurs != null)
                    {
                        var acteursList = ((IEnumerable<SelectListItem>)ViewBag.Acteurs).ToList();
                        if (acteursList.Any())
                        {
                            @foreach (var acteurs in acteursList)
                            {
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input type="checkbox" name="selectedActeurs" value="@acteurs.Value" class="form-check-input"
                                   onclick="validateActeursSelection(); return validateActeursSelection();" />
                                        <label class="form-check-label">@acteurs.Text</label>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <p>Aucun acteurs disponibles</p>
                        }
                    }
                    else
                    {
                        <p>Aucun acteurs disponibles</p>
                    }
                </div>
                <br>
                <div class="row">
                    <div class="col-md-10">
                        <input type="text" id="newActeur" class="form-control" placeholder="Ajouter un nouvel acteur" />
                    </div>
                    <div class="col-md-10">
                        <select id="newActeurGender" class="form-control">
                            <option value="">Sélectionnez le genre</option>
                            <option value="H">Homme</option>
                            <option value="F">Femme</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="button" onclick="addNewActeur()" class="btn btn-primary">Ajouter</button>
                    </div>
                </div>
                <span id="acteursValidationError" class="text-danger"></span>
            </div>
            <br>


            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary" />
            </div>

        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Retour à la liste</a>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
